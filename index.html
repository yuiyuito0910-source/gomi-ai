<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GomiVision | ã”ã¿åˆ†åˆ¥AI</title>

<!-- TensorFlow.js & Teachable Machine -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";
  import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBPzh1PUGiT3ydeValzdoAjI1_-qnFbiRY",
    authDomain: "gomivisioncloud.firebaseapp.com",
    projectId: "gomivisioncloud",
    storageBucket: "gomivisioncloud.firebasestorage.app",
    messagingSenderId: "1031788205291",
    appId: "1:1031788205291:web:1205b1ebfb10f2e5365aae"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  window.firebaseDB = db;
  window.firebaseStorage = storage;
</script>

<style>
body { font-family:'Segoe UI',Arial,sans-serif; text-align:center; background: linear-gradient(135deg,#e0f7fa,#ffffff); margin:0; padding:20px; color:#333;}
h1 { margin-bottom:5px; font-size:28px; color:#009688;}
.subtitle { margin-bottom:20px; font-size:16px; color:#555;}
video,img{width:100%;max-width:400px;height:auto;border-radius:20px;margin-top:15px;background:#ccefff;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
button{width:90%;max-width:360px;padding:14px;margin:8px 0;border-radius:12px;border:none;background:linear-gradient(45deg,#26a69a,#80cbc4);color:#fff;font-size:16px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.2);transition:0.3s;}
button:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,0.3);}
.result-box{margin-top:20px;padding:20px;background:#ffffffcc;border-radius:20px;width:90%;max-width:400px;margin-left:auto;margin-right:auto;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
.progress{width:100%;background:#e0e0e0;border-radius:12px;margin-top:10px;}
.progress-bar{height:16px;width:0%;background:#26a69a;border-radius:12px;transition:width 0.6s ease, background 0.6s ease;}
#confidenceText{margin-top:5px;font-size:14px;font-weight:bold;}
#advice{font-size:16px;color:#555;margin-top:5px;min-height:20px;}
#history{margin-top:20px;max-height:200px;overflow-y:auto;}
.history-card{background:#f1fdfd;padding:10px;margin:5px 0;border-radius:12px;display:flex;justify-content:space-between;align-items:center;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.history-card img{width:40px;height:40px;border-radius:8px;object-fit:cover;margin-right:8px;}
.fixBtn{background:#ff8a65;padding:4px 8px;border-radius:8px;font-size:12px;}
</style>
</head>
<body>

<h1>â™» GomiVision</h1>
<div class="subtitle">æ’®ã‚‹ã ã‘ã§åˆ†åˆ¥ã§ãã‚‹AI</div>

<input type="file" id="imageInput" accept="image/*"><br>

<video id="camera" autoplay playsinline></video><br>
<button onclick="toggleCamera()" id="cameraBtn">ã‚«ãƒ¡ãƒ©ON</button>
<button onclick="switchCamera()" id="switchBtn">ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
<button onclick="takePhoto()">æ’®å½±</button>
<button onclick="retrainAndUpdateModel()">ğŸ”„ AI å†å­¦ç¿’ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰</button>

<img id="preview">

<div class="result-box">
  <div id="result">ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...</div>
  <div class="progress">
    <div class="progress-bar" id="confidenceBar"></div>
  </div>
  <div id="confidenceText"></div>
  <div id="advice"></div>
</div>

<h3>åˆ¤å®šå±¥æ­´</h3>
<div id="history"></div>

<script>
const URL_PATH="https://yuiyuito0910-source.github.io/gomi-ai/";
let model, cameraOn=false, stream=null, cameraFacing="user";
let historyData=JSON.parse(localStorage.getItem('gomiHistory')||"[]");

const recycleTips={"ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯":"æ´—ã£ã¦ã‹ã‚‰å¯ç‡ƒã”ã¿ã¸ã€‚","ç¼¶":"ä¸­ã‚’æ´—ã£ã¦è³‡æºã”ã¿ã¸ã€‚","ãƒšãƒƒãƒˆãƒœãƒˆãƒ«":"ãƒ©ãƒ™ãƒ«ã¨ã‚­ãƒ£ãƒƒãƒ—ã‚’å¤–ã—ã¦è³‡æºã”ã¿ã¸ã€‚","ç´™":"æ±šã‚ŒãŒãªã‘ã‚Œã°å¤ç´™å›åã¸ã€‚","ä¸ç‡ƒç‰©":"å¸‚ç”ºæ‘æŒ‡å®šã®ä¸ç‡ƒã”ã¿ã¸ã€‚"};

function updateHistory(){
  const historyDiv=document.getElementById("history");
  historyDiv.innerHTML="";
  historyData.slice().reverse().forEach((item)=>{
    const card=document.createElement("div"); card.className="history-card";
    const img=document.createElement("img"); img.src=item.imgSrc;
    const text=document.createElement("span"); text.innerText=item.label+" ("+Math.round(item.prob*100)+"%)";
    const btn=document.createElement("button"); btn.innerText="ä¿®æ­£"; btn.className="fixBtn";
    btn.onclick=async ()=>{
      const newLabel=prompt("æ­£ã—ã„ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",item.label);
      if(newLabel){
        item.label=newLabel;
        localStorage.setItem('gomiHistory',JSON.stringify(historyData));
        updateHistory();
        // Firestore æ›´æ–°
        try{
          const q = query(collection(window.firebaseDB,'predictions'), where('imgPath','==',item.imgSrc));
          const snap = await getDocs(q);
          snap.forEach(d => { updateDoc(d.ref, {correctedLabel:newLabel}); });
        }catch(e){console.error("Firestore æ›´æ–°ã‚¨ãƒ©ãƒ¼",e);}
      }
    };
    card.appendChild(img); card.appendChild(text); card.appendChild(btn);
    historyDiv.appendChild(card);
  });
}

async function init(){
  try{
    model=await tmImage.load(URL_PATH+"model.json",URL_PATH+"metadata.json");
    document.getElementById("result").innerText="æº–å‚™å®Œäº†ï¼ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
    updateHistory();
  }catch(error){
    document.getElementById("result").innerText="ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—";
    console.error(error);
  }
}

init();

async function predict(img){
  const prediction=await model.predict(img);
  let highest=prediction[0];
  for(let i=1;i<prediction.length;i++) if(prediction[i].probability>highest.probability) highest=prediction[i];
  const confidence=highest.probability;
  const bar=document.getElementById("confidenceBar");
  const confText=document.getElementById("confidenceText");
  if(confidence<0.6) bar.style.background="#ff7043";
  else if(confidence<0.8) bar.style.background="#ffee58";
  else bar.style.background="#26a69a";

  if(confidence<0.6){
    document.getElementById("result").innerText="âš  åˆ¤å®šä¸æ˜";
    bar.style.width="0%"; confText.innerText="";
    document.getElementById("advice").innerText="ã‚‚ã†ä¸€åº¦æ’®å½±ã—ã¦ãã ã•ã„ã€‚";
    return;
  }

  document.getElementById("result").innerText="åˆ†é¡: "+highest.className;
  bar.style.width=(confidence*100)+"%";
  confText.innerText="ä¿¡é ¼åº¦: "+Math.round(confidence*100)+"%";
  document.getElementById("advice").innerText=recycleTips[highest.className]||"";

  const newHistory={imgSrc:img.src,label:highest.className,prob:confidence};
  historyData.push(newHistory);
  localStorage.setItem('gomiHistory',JSON.stringify(historyData));
  updateHistory();

  sendToCloud(img,highest.className,confidence);
}

async function sendToCloud(img,label,prob){
  try{
    const fileName='images/'+Date.now()+'.png';
    const imgRef=ref(window.firebaseStorage,fileName);
    await uploadString(imgRef,img.src,'data_url');
    await addDoc(collection(window.firebaseDB,'predictions'),{label:label,confidence:prob,timestamp:new Date().toISOString(),imgPath:fileName});
    console.log("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜å®Œäº†");
  }catch(error){console.error("ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã‚¨ãƒ©ãƒ¼",error);}
}

document.getElementById("imageInput").addEventListener("change",e=>{
  const file=e.target.files[0]; if(!file)return;
  const img=document.getElementById("preview");
  img.onload=()=>predict(img);
  img.src=URL.createObjectURL(file);
});

async function toggleCamera(){
  const video=document.getElementById("camera"); const button=document.getElementById("cameraBtn");
  if(!cameraOn){ stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:cameraFacing}}); video.srcObject=stream; button.innerText="ã‚«ãƒ¡ãƒ©OFF"; cameraOn=true;}
  else{ stream.getTracks().forEach(track=>track.stop()); video.srcObject=null; button.innerText="ã‚«ãƒ¡ãƒ©ON"; cameraOn=false;}
}

async function switchCamera(){
  if(!cameraOn)return; stream.getTracks().forEach(track=>track.stop());
  cameraFacing=cameraFacing==="user"?"environment":"user";
  const video=document.getElementById("camera");
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:cameraFacing}});
  video.srcObject=stream;
}

function takePhoto(){
  if(!cameraOn)return;
  const video=document.getElementById("camera");
  const canvas=document.createElement("canvas"); canvas.width=224; canvas.height=224;
  const ctx=canvas.getContext("2d"); ctx.drawImage(video,0,0,224,224);
  const img=document.getElementById("preview"); img.src=canvas.toDataURL("image/png"); img.onload=()=>predict(img);
}

// ğŸ”„ è‡ªå‹•å†å­¦ç¿’
async function retrainAndUpdateModel(){
  const statusDiv = document.getElementById("retrainStatus");
  statusDiv.innerText = "è‡ªå‹•å†å­¦ç¿’é–‹å§‹â€¦å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™";

  try{
    const q = query(collection(window.firebaseDB, "predictions"), where("confidence", ">=", 0.6));
    const querySnapshot = await getDocs(q);
    if(querySnapshot.empty){ statusDiv.innerText = "å†å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"; return; }

    const images = []; const labels = [];
    const classNames = model.getClassLabels();
    const numClasses = classNames.length;

    for(const docSnap of querySnapshot.docs){
      const data = docSnap.data();
      const labelName = data.correctedLabel || data.label;
      const imgRef = ref(window.firebaseStorage, data.imgPath);
      const url = await getDownloadURL(imgRef);
      const img = new Image(); img.crossOrigin="anonymous"; img.src=url; await new Promise(res=>img.onload=res);
      const tensor = tf.browser.fromPixels(img).resizeNearestNeighbor([224,224]).toFloat().div(255.0);
      images.push(tensor); labels.push(tf.oneHot(classNames.indexOf(labelName), numClasses));
    }

    const xs = tf.stack(images); const ys = tf.stack(labels);

    const newModel = tf.sequential();
    for(let i=0;i<model.model.layers.length-1;i++) newModel.add(model.model.layers[i]);
    newModel.add(tf.layers.dense({units:numClasses, activation:'softmax'}));
    newModel.compile({optimizer:'adam', loss:'categoricalCrossentropy', metrics:['accuracy']});

    await newModel.fit(xs, ys, {epochs:5, batchSize:8, shuffle:true});
    statusDiv.innerText = "å†å­¦ç¿’å®Œäº†ï¼ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„";

    // ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    await newModel.save('downloads://updated-model');

    xs.dispose(); ys.dispose();

  }catch(e){console.error(e); statusDiv.innerText = "å†å­¦ç¿’ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";}
}
</script>
</body>
</html>
